<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff — Meadow Pathways</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="robots" content="noindex" />
</head>
<body>
  <header class="site-header container">
    <a href="index.html"><img src="Logo.png" alt="Meadow Pathways Logo" style="height:72px"></a>
  </header>

  <main class="container">
    <section class="card">
      <h1>Staff area</h1>
      <p>This area is restricted. Please sign in to continue.</p>

      <div id="loginControls" style="margin:16px 0;">
        <button id="loginBtn" class="btn">Sign in / Register</button>
        <button id="logoutBtn" class="btn" style="display:none;">Sign out</button>
      </div>

      <!-- Protected panel: hidden until user is logged in and has 'staff' role -->
      <div id="staffPanel" style="display:none;">
        <h2>Internal information</h2>
        <p>This page contains protected resources and notes for staff use only. Please do not share externally.</p>
        <ul>
          <li>Formspree endpoint for legacy forms: <code>https://formspree.io/f/movnvzqp</code></li>
          <li>General contact email: <a href="mailto:meadowpathwayscornwall@outlook.com">meadowpathwayscornwall@outlook.com</a></li>
          <li>Michelle — <a href="mailto:Michelle.Pascoe@meadowpathwayscornwall.com">Michelle.Pascoe@meadowpathwayscornwall.com</a> — 07932 243358</li>
          <li>Zoe — <a href="mailto:Zoe.Waitz@meadowpathwayscornwall.com">Zoe.Waitz@meadowpathwayscornwall.com</a> — 07775 733587</li>
        </ul>

        <h3>Downloads (internal policies)</h3>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <a class="pill" href="MPWEC Safeguarding and Child Protection Policy Sep 2025.docx" download>Safeguarding and Child Protection Policy</a>
          <a class="pill" href="MPWEC Behaviour Policy.docx" download>Behaviour Policy</a>
          <a class="pill" href="MPWEC Staff Conduct Policy.docx" download>Staff Conduct Policy</a>
          <a class="pill" href="MPWEC Whistleblowing Policy.docx" download>Whistleblowing Policy</a>
        </div>

        <h3 style="margin-top:18px">Hours logging</h3>
        <form name="hours" method="POST" data-netlify="true" netlify-honeypot="bot-field" id="hoursForm">
          <input type="hidden" name="form-name" value="hours" />
          <label>Staff member name <input name="staff_name" required></label>
          <label>Date worked <input name="date_worked" type="date" required></label>
          <label>Duration (hours) <input name="duration_hours" type="number" step="0.25" min="0" required></label>
          <label>Notes <textarea name="notes"></textarea></label>
          <label>Staff email <input name="staff_email" type="email" value="Michelle.Pascoe@meadowpathwayscornwall.com" required></label>
          <button type="submit">Submit hours</button>
          <div id="hoursStatus" aria-live="polite"></div>
        </form>
      </div>

      <div id="notAllowed" style="display:none;color:#b00;margin-top:12px;">
        You are signed in but do not have staff access. Contact an administrator to be granted the <strong>staff</strong> role.
      </div>
    </section>
  </main>

  <footer class="site-footer container text-center">
    <p>© 2025 Meadow Pathways Wellbeing and Education Cornwall Ltd</p>
  </footer>

  <!-- Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    // Netlify Identity init & role check
    if (window.netlifyIdentity) {
      const identity = netlifyIdentity;
      identity.on('init', user => {
        // user === null if not logged in
        checkUser(user);
      });
      identity.on('login', user => { checkUser(user); });
      identity.on('logout', () => { checkUser(null); });

      document.getElementById('loginBtn').addEventListener('click', function(){
        identity.open(); // opens the modal
      });
      document.getElementById('logoutBtn').addEventListener('click', function(){
        identity.logout();
      });

      function checkUser(user) {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const staffPanel = document.getElementById('staffPanel');
        const notAllowed = document.getElementById('notAllowed');

        if(!user) {
          loginBtn.style.display = '';
          logoutBtn.style.display = 'none';
          staffPanel.style.display = 'none';
          notAllowed.style.display = 'none';
          return;
        }
        // user.app_metadata contains roles
        const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
        loginBtn.style.display = 'none';
        logoutBtn.style.display = '';
        if(roles.includes('staff')) {
          staffPanel.style.display = '';
          notAllowed.style.display = 'none';
        } else {
          staffPanel.style.display = 'none';
          notAllowed.style.display = '';
        }
      }
    }
  </script>

  <script>
    // hours form submit handler for Netlify forms feedback (AJAX)
    const hoursForm = document.getElementById('hoursForm');
    if (hoursForm) {
      hoursForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const status = document.getElementById('hoursStatus');
        status.textContent = 'Submitting...';
        const data = new FormData(hoursForm);
        try {
          const res = await fetch('/', { method: 'POST', body: data });
          if (res.ok) {
            hoursForm.reset();
            status.textContent = 'Hours submitted. Thank you.';
          } else {
            status.textContent = 'Submission error — try again later.';
          }
        } catch (err) {
          status.textContent = 'Network error — check connection and try again.';
        }
      });
    }
  </script>
</body>
</html>
